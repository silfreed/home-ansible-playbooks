[Unit]
Description={{ description }}
After=network-online.target
Wants=network-online.target
{% if lvm is defined %}RequiresMountsFor={% for lvm in lvm %}/mnt/{{ lvm.name }} {% endfor %}{% endif %}{{''}}

# https://blog.container-solutions.com/running-docker-containers-with-systemd
[Service]
TimeoutStartSec=0
Restart=always
ExecStartPre=-/usr/bin/docker stop %i
ExecStartPre=-/usr/bin/docker rm %i
ExecStartPre=/usr/bin/docker pull {{ docker_hub_image }}
ExecStart=/usr/bin/docker run --rm --name %i \
{% set docker_cmd_output = [] -%}
{% if docker_options is defined %}
{%   for dockopt in docker_options %}
{{-     docker_cmd_output.append(dockopt|string) -}}
{%   endfor %}
{% endif %}
{% if docker_ports is defined %}
{%   for k,v in docker_ports.items() %}
{{-     docker_cmd_output.append("-p " + k|string + ":" + v|string) -}}
{%   endfor %}
{% endif %}
{% if docker_env is defined %}
{%   for k,v in docker_env.items() %}
{{-     docker_cmd_output.append("-e " + k|string + "=" + v|string) -}}
{%   endfor %}
{% endif %}
{% if docker_vols is defined %}
{%   for k,v in docker_vols.items() %}
{{-    docker_cmd_output.append("-v " + k|string + ":" + v|string) -}}
{%   endfor %}
{% endif %}
{{- docker_cmd_output.append(docker_hub_image) -}}
{% if docker_cli_opts is defined %}
{%   for dcliopts in docker_cli_opts %}
{{-     docker_cmd_output.append(dcliopts|string) -}}
{%   endfor %}
{% endif %}
  {{ docker_cmd_output | join(" \\"+"\n") | indent(width=2) }}

[Install]
WantedBy=multi-user.target
